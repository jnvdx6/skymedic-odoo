<?xml version="1.0"?>
<odoo>

    <!-- Portfolio Kanban View -->
    <record id="view_partner_commercial_kanban" model="ir.ui.view">
        <field name="name">res.partner.kanban.commercial_portfolio</field>
        <field name="model">res.partner</field>
        <field name="arch" type="xml">
            <kanban>
                <field name="id"/>
                <field name="name"/>
                <field name="city"/>
                <field name="commercial_score"/>
                <field name="days_since_last_visit"/>
                <field name="visit_count_ytd"/>
                <field name="visit_frequency_target"/>
                <field name="commercial_alert_overdue"/>
                <field name="commercial_alert_declining"/>
                <field name="commercial_alert_opportunity"/>
                <field name="next_commercial_activity_date"/>
                <field name="color"/>
                <templates>
                    <t t-name="card">
                        <div class="d-flex justify-content-between">
                            <strong>
                                <field name="name"/>
                            </strong>
                            <span class="badge text-bg-primary rounded-pill">
                                <field name="commercial_score"
                                    options="{'digits': [3, 0]}"/>
                            </span>
                        </div>
                        <div class="text-muted small">
                            <field name="city"/>
                        </div>
                        <div class="mt-1">
                            <span class="me-2" title="Días sin visita">
                                <i class="fa fa-clock-o"/>
                                <field name="days_since_last_visit"/> d
                            </span>
                            <span title="Visitas YTD">
                                <i class="fa fa-check"/>
                                <field name="visit_count_ytd"/>/<field name="visit_frequency_target"/>
                            </span>
                        </div>
                        <!-- Alerts -->
                        <div class="mt-1">
                            <span class="badge text-bg-danger me-1"
                                t-if="record.commercial_alert_overdue.raw_value">
                                Sin visitar
                            </span>
                            <span class="badge text-bg-warning me-1"
                                t-if="record.commercial_alert_declining.raw_value">
                                En declive
                            </span>
                            <span class="badge text-bg-success me-1"
                                t-if="record.commercial_alert_opportunity.raw_value">
                                Cross-sell
                            </span>
                        </div>
                        <!-- Quick actions -->
                        <div class="mt-2">
                            <button name="action_quick_log_visit" type="object"
                                class="btn btn-sm btn-primary me-1"
                                title="Registrar Visita">
                                <i class="fa fa-map-marker"/> Visita
                            </button>
                            <button name="action_quick_log_call" type="object"
                                class="btn btn-sm btn-outline-secondary"
                                title="Registrar Llamada">
                                <i class="fa fa-phone"/> Llamada
                            </button>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Portfolio List View -->
    <record id="view_partner_commercial_list" model="ir.ui.view">
        <field name="name">res.partner.list.commercial_portfolio</field>
        <field name="model">res.partner</field>
        <field name="arch" type="xml">
            <list decoration-danger="commercial_alert_overdue"
                  decoration-warning="commercial_alert_declining"
                  default_order="commercial_score desc">
                <field name="name"/>
                <field name="city"/>
                <field name="commercial_score" string="Puntuación"
                    decoration-bf="1"/>
                <field name="days_since_last_visit" string="Días sin visita"
                    decoration-success="days_since_last_visit &lt; 30"
                    decoration-warning="days_since_last_visit &gt;= 30 and days_since_last_visit &lt; 60"
                    decoration-danger="days_since_last_visit &gt;= 60"/>
                <field name="volume_tag_ids" string="Volumen"
                    widget="many2many_tags"
                    options="{'color_field': 'color'}"
                    optional="show"/>
                <field name="trend_tag_ids" string="Tendencia"
                    widget="many2many_tags"
                    options="{'color_field': 'color'}"
                    optional="show"/>
                <field name="crosssell_tag_ids" string="Cross-sell"
                    widget="many2many_tags"
                    options="{'color_field': 'color'}"
                    optional="hide"/>
                <field name="next_commercial_activity_date" string="Próxima Act."
                    optional="show"/>
                <field name="visit_count_ytd" string="Visitas YTD"
                    optional="show"/>
                <field name="visit_frequency_target" string="Objetivo"
                    optional="hide"/>
                <field name="commercial_alert_overdue" column_invisible="True"/>
                <field name="commercial_alert_declining" column_invisible="True"/>
                <field name="commercial_alert_opportunity" column_invisible="True"/>
            </list>
        </field>
    </record>

    <!-- Portfolio Search View -->
    <record id="view_partner_commercial_search" model="ir.ui.view">
        <field name="name">res.partner.search.commercial_portfolio</field>
        <field name="model">res.partner</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="city"/>
                <field name="commercial_user_id"/>
                <separator/>
                <filter string="Mis Clientes" name="my_clients"
                    domain="[('commercial_user_id', '=', uid)]"/>
                <separator/>
                <filter string="Visitas Vencidas" name="overdue"
                    domain="[('commercial_alert_overdue', '=', True)]"/>
                <filter string="En Declive" name="declining"
                    domain="[('commercial_alert_declining', '=', True)]"/>
                <filter string="Oportunidad Cross-sell" name="crosssell"
                    domain="[('commercial_alert_opportunity', '=', True)]"/>
                <separator/>
                <group expand="0" string="Agrupar por">
                    <filter string="Volumen" name="group_volume"
                        context="{'group_by': 'volume_tag_ids'}"/>
                    <filter string="Tendencia" name="group_trend"
                        context="{'group_by': 'trend_tag_ids'}"/>
                    <filter string="Comercial" name="group_user"
                        context="{'group_by': 'commercial_user_id'}"/>
                    <filter string="Ciudad" name="group_city"
                        context="{'group_by': 'city'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Portfolio Action -->
    <record id="action_commercial_portfolio" model="ir.actions.act_window">
        <field name="name">Mis Clientes</field>
        <field name="res_model">res.partner</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="view_ids" eval="[
            (5, 0, 0),
            (0, 0, {'view_mode': 'kanban', 'view_id': ref('view_partner_commercial_kanban')}),
            (0, 0, {'view_mode': 'list', 'view_id': ref('view_partner_commercial_list')}),
        ]"/>
        <field name="search_view_id" ref="view_partner_commercial_search"/>
        <field name="domain">[('commercial_user_id', '!=', False), ('is_company', '=', True)]</field>
        <field name="context">{
            'search_default_my_clients': 1,
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay clientes asignados.
            </p>
            <p>Asigna un comercial a los contactos para que aparezcan aquí.</p>
        </field>
    </record>

</odoo>
